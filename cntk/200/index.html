<!doctype html><html lang="zh" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content="The website of Zhiyuan Chen"><link rel="canonical" href="https://zyc.ai/cntk/200/"><meta name="author" content="Zhiyuan Chen"><meta name="lang:clipboard.copy" content="复制"><meta name="lang:clipboard.copied" content="已复制"><meta name="lang:search.language" content="ja"><meta name="lang:search.pipeline.stopwords" content="True"><meta name="lang:search.pipeline.trimmer" content="True"><meta name="lang:search.result.none" content="没有找到符合条件的结果"><meta name="lang:search.result.one" content="找到 1 个符合条件的结果"><meta name="lang:search.result.other" content="# 个符合条件的结果"><meta name="lang:search.tokenizer" content="[\uff0c\u3002]+"><link rel="shortcut icon" href="../../images/favicon.ico"><meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.3.1"><title>200</title><link rel="stylesheet" href="../../assets/stylesheets/application.4031d38b.css"><link rel="stylesheet" href="../../assets/stylesheets/application-palette.224b79ff.css"><meta name="theme-color" content="#009688"><script src="../../assets/javascripts/modernizr.74668098.js"></script><link href="https://fonts.gstatic.com" rel="preconnect" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700|Cascadia+Code&display=swap"><style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Cascadia Code","Courier New",Courier,monospace}</style><link rel="stylesheet" href="../../assets/fonts/material-icons.css"><link rel="manifest" href="../../manifest.webmanifest"><link rel="stylesheet" href="../../css/css.css"><link rel="stylesheet" href="../../css/extra.css"><script>window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-104387513-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })</script><script async src="https://www.google-analytics.com/analytics.js"></script></head><body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal"><svg class="md-svg"><defs><svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg></defs></svg> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" data-md-component="overlay" for="__drawer"></label><a href="#200" tabindex="1" class="md-skip">跳转至 </a><header class="md-header" data-md-component="header"><nav class="md-header-nav md-grid"><div class="md-flex"><div class="md-flex__cell md-flex__cell--shrink"><a href="https://zyc.ai" title="Zhiyuan Chen" class="md-header-nav__button md-logo"><img src="../../images/zc.png" width="24" height="24"></a></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label></div><div class="md-flex__cell md-flex__cell--stretch"><div class="md-flex__ellipsis md-header-nav__title" data-md-component="title"><span class="md-header-nav__topic">Zhiyuan Chen</span><span class="md-header-nav__topic">200</span></div></div><div class="md-flex__cell md-flex__cell--shrink"><label class="md-icon md-icon--search md-header-nav__button" for="__search"></label><div class="md-search" data-md-component="search" role="dialog"><label class="md-search__overlay" for="__search"></label><div class="md-search__inner" role="search"><form class="md-search__form" name="search"><input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active"> <label class="md-icon md-search__icon" for="__search"></label> <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button></form><div class="md-search__output"><div class="md-search__scrollwrap" data-md-scrollfix><div class="md-search-result" data-md-component="result"><div class="md-search-result__meta">键入以开始搜索</div><ol class="md-search-result__list"></ol></div></div></div></div></div></div><div class="md-flex__cell md-flex__cell--shrink"><div class="md-header-nav__source"><a href="https://github.com/zyc-ai/" title="前往 Github 仓库" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Zhiyuan Chen</div></a></div></div></div></nav></header><div class="md-container"><nav class="md-tabs md-tabs--active" data-md-component="tabs"><div class="md-tabs__inner md-grid"><ul class="md-tabs__list"><li class="md-tabs__item"><a href="../.." title="Master" class="md-tabs__link">Master</a></li><li class="md-tabs__item"><a href="../../document/design_pattern/" title="文档" class="md-tabs__link">文档</a></li><li class="md-tabs__item"><a href="../../stat/probability/" title="统计" class="md-tabs__link">统计</a></li><li class="md-tabs__item"><a href="../../algorithm/introduction/" title="算法" class="md-tabs__link">算法</a></li><li class="md-tabs__item"><a href="../../k8s/introduction/" title="Kubernetes" class="md-tabs__link">Kubernetes</a></li><li class="md-tabs__item"><a href="../../docker/introduction/" title="Docker" class="md-tabs__link">Docker</a></li><li class="md-tabs__item"><a href="../introduction/" title="CNTK" class="md-tabs__link md-tabs__link--active">CNTK</a></li><li class="md-tabs__item"><a href="../../cppcg/CppCoreGuidelines/" title="C++核心指南" class="md-tabs__link">C++核心指南</a></li><li class="md-tabs__item"><a href="../../sketch/20190610/" title="随笔" class="md-tabs__link">随笔</a></li></ul></div></nav><main class="md-main"><div class="md-main__inner md-grid" data-md-component="container"><div class="md-sidebar md-sidebar--primary" data-md-component="navigation"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--primary" data-md-level="0"><label class="md-nav__title md-nav__title--site" for="__drawer"><a href="https://zyc.ai" title="Zhiyuan Chen" class="md-nav__button md-logo"><img src="../../images/zc.png" width="48" height="48"></a>Zhiyuan Chen</label><div class="md-nav__source"><a href="https://github.com/zyc-ai/" title="前往 Github 仓库" class="md-source" data-md-source="github"><div class="md-source__icon"><svg viewBox="0 0 24 24" width="24" height="24"><use xlink:href="#__github" width="24" height="24"></use></svg></div><div class="md-source__repository">Zhiyuan Chen</div></a></div><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1"><label class="md-nav__link" for="nav-1">Master</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-1">Master</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../.." title="首页" class="md-nav__link">首页</a></li><li class="md-nav__item"><a href="../../master/donate/" title="捐赠" class="md-nav__link">捐赠</a></li><li class="md-nav__item"><a href="../../master/contribute/" title="贡献" class="md-nav__link">贡献</a></li><li class="md-nav__item"><a href="../../master/policy/" title="政策" class="md-nav__link">政策</a></li><li class="md-nav__item"><a href="../../master/license/" title="许可" class="md-nav__link">许可</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2"><label class="md-nav__link" for="nav-2">文档</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-2">文档</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../document/design_pattern/" title="设计模式" class="md-nav__link">设计模式</a></li><li class="md-nav__item"><a href="../../document/jetbrains/" title="JetBrains使用指南" class="md-nav__link">JetBrains使用指南</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3"><label class="md-nav__link" for="nav-3">统计</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-3">统计</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../stat/probability/" title="概率论" class="md-nav__link">概率论</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4"><label class="md-nav__link" for="nav-4">算法</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-4">算法</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../algorithm/introduction/" title="算法导论" class="md-nav__link">算法导论</a></li><li class="md-nav__item"><a href="../../algorithm/complexity/" title="复杂度" class="md-nav__link">复杂度</a></li><li class="md-nav__item"><a href="../../algorithm/tree/" title="树" class="md-nav__link">树</a></li><li class="md-nav__item"><a href="../../algorithm/recurrence_relation/" title="递推方程" class="md-nav__link">递推方程</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5"><label class="md-nav__link" for="nav-5">Kubernetes</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-5">Kubernetes</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../k8s/introduction/" title="导论" class="md-nav__link">导论</a></li><li class="md-nav__item"><a href="../../k8s/component/" title="组件" class="md-nav__link">组件</a></li><li class="md-nav__item"><a href="../../k8s/installation/" title="安装" class="md-nav__link">安装</a></li><li class="md-nav__item"><a href="../../k8s/pods/" title="Pods" class="md-nav__link">Pods</a></li><li class="md-nav__item"><a href="../../k8s/deployments/" title="Deployments" class="md-nav__link">Deployments</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6"><label class="md-nav__link" for="nav-6">Docker</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-6">Docker</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../docker/introduction/" title="导论" class="md-nav__link">导论</a></li><li class="md-nav__item"><a href="../../docker/installation/" title="安装" class="md-nav__link">安装</a></li><li class="md-nav__item"><a href="../../docker/command_line_interface/" title="命令行接口" class="md-nav__link">命令行接口</a></li><li class="md-nav__item"><a href="../../docker/dockerfile/" title="Dockerfile" class="md-nav__link">Dockerfile</a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked><label class="md-nav__link" for="nav-7">CNTK</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-7">CNTK</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../introduction/" title="导论" class="md-nav__link">导论</a></li><li class="md-nav__item md-nav__item--active"><input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc"><label class="md-nav__link md-nav__link--active" for="__toc">200</label><a href="./" title="200" class="md-nav__link md-nav__link--active">200</a><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">目录</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="引言" class="md-nav__link">引言</a></li><li class="md-nav__item"><a href="#_2" title="定义模型结构" class="md-nav__link">定义模型结构</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#cntk" title="CNTK编程模型：作为函数对象的网络" class="md-nav__link">CNTK编程模型：作为函数对象的网络</a></li><li class="md-nav__item"><a href="#cntk_1" title="CNTK数据模型：张量和张量序列" class="md-nav__link">CNTK数据模型：张量和张量序列</a></li><li class="md-nav__item"><a href="#cntklogistic" title="你的第一个CNTK网络：Logistic回归" class="md-nav__link">你的第一个CNTK网络：Logistic回归</a></li><li class="md-nav__item"><a href="#cntkmnist" title="你的第二个CNTK网络：MNIST数字识别" class="md-nav__link">你的第二个CNTK网络：MNIST数字识别</a></li><li class="md-nav__item"><a href="#apimnist" title="图谱API：再来一次MNIST数字识别" class="md-nav__link">图谱API：再来一次MNIST数字识别</a></li></ul></nav></li><li class="md-nav__item"><a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">评论</a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8"><label class="md-nav__link" for="nav-8">C++核心指南</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-8">C++核心指南</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../cppcg/CppCoreGuidelines/" title="原文" class="md-nav__link">原文</a></li><li class="md-nav__item"><a href="../../cppcg/abstract/" title="摘要" class="md-nav__link">摘要</a></li></ul></nav></li><li class="md-nav__item md-nav__item--nested"><input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9"><label class="md-nav__link" for="nav-9">随笔</label><nav class="md-nav" data-md-component="collapsible" data-md-level="1"><label class="md-nav__title" for="nav-9">随笔</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="../../sketch/20190610/" title="二〇一九年 六月 十日" class="md-nav__link">二〇一九年 六月 十日</a></li><li class="md-nav__item"><a href="../../sketch/20191108/" title="二〇一九年 十一月 八日" class="md-nav__link">二〇一九年 十一月 八日</a></li><li class="md-nav__item"><a href="../../sketch/20200404/" title="二〇二〇年 四月 四日" class="md-nav__link">二〇二〇年 四月 四日</a></li></ul></nav></li></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component="toc"><div class="md-sidebar__scrollwrap"><div class="md-sidebar__inner"><nav class="md-nav md-nav--secondary"><label class="md-nav__title" for="__toc">目录</label><ul class="md-nav__list" data-md-scrollfix><li class="md-nav__item"><a href="#_1" title="引言" class="md-nav__link">引言</a></li><li class="md-nav__item"><a href="#_2" title="定义模型结构" class="md-nav__link">定义模型结构</a><nav class="md-nav"><ul class="md-nav__list"><li class="md-nav__item"><a href="#cntk" title="CNTK编程模型：作为函数对象的网络" class="md-nav__link">CNTK编程模型：作为函数对象的网络</a></li><li class="md-nav__item"><a href="#cntk_1" title="CNTK数据模型：张量和张量序列" class="md-nav__link">CNTK数据模型：张量和张量序列</a></li><li class="md-nav__item"><a href="#cntklogistic" title="你的第一个CNTK网络：Logistic回归" class="md-nav__link">你的第一个CNTK网络：Logistic回归</a></li><li class="md-nav__item"><a href="#cntkmnist" title="你的第二个CNTK网络：MNIST数字识别" class="md-nav__link">你的第二个CNTK网络：MNIST数字识别</a></li><li class="md-nav__item"><a href="#apimnist" title="图谱API：再来一次MNIST数字识别" class="md-nav__link">图谱API：再来一次MNIST数字识别</a></li></ul></nav></li><li class="md-nav__item"><a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">评论</a></li></ul></nav></div></div></div><div class="md-content"><article class="md-content__inner md-typeset"><a href="https://github.com/zyc-ai/edit/master/docs/cntk/200.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a><h1 id="200">200<a class="headerlink" href="#200" title="Permanent link">#</a></h1>
<p><em>本文翻译自微软官方文档<a href="https://cntk.ai/pythondocs/CNTK_200_GuidedTour.html">CNTK 200: A Guided Tour</a>。</em></p>
<p>本教程介绍了CNTK的许多高级功能，适用于之前曾接触过深度学习和/或其他深度学习工具集的人。如果你是初学者，我们建议你从<a href="https://cntk.ai/pythondocs/CNTK_101_LogisticRegression.html">CNTK 101教程</a>开始，并在完成100系列的大部分教程后再来这里。</p>
<h2 id="_1">引言<a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<p>欢迎来到CNTK！深度神经网络正在重新定义计算机程序的创建方式。除了命令式，功能性，声明式编程之外，我们现在还具有可区分的编程，可以从数据中有效地“学习”程序。</p>
<p>CNTK是Microsoft产品组用于为各种产品创建深层模型的主要工具，从语音识别和机器翻译到各种图像分类服务，再到必应搜索排名。</p>
<p>本教程是CNTK的导览。它主要面向新上手CNTK但具有深度神经网络经验的用户。重点将放在如何在CNTK中完成深度学习的基本步骤，我们将主要通过实例展示。此导览不是完整的API说明。相反，我们会将读者引用到文档和特定于任务的教程中，以获取更多详细信息。</p>
<p>要训​​练深层模型，你需要定义模型结构，准备数据，以便将数据输入CNTK，训练模型并评估其准确性，然后进行部署。</p>
<p>本教程的组织结构如下：</p>
<ul>
<li>定义 <strong>模型结构</strong><ul>
<li>CNTK编程模型：作为函数对象的网络</li>
<li>CNTK数据模型：张量和张量序列</li>
<li>你的第一个CNTK网络：Logistic回归</li>
<li>你的第二个CNTK网络：MNIST数字识别</li>
<li>图谱API：再来一次MNIST数字识别</li>
</ul>
</li>
<li>提供 <strong>数据</strong><ul>
<li>适合内存的小数据集：numpy/ scipy数组/</li>
<li>大数据集：<code>MinibatchSource</code>类</li>
<li>分步传输数据：你自己的小批次梯度循环</li>
</ul>
</li>
<li><strong>训练</strong><ul>
<li>分布式训练</li>
<li>记录</li>
<li>检查点</li>
<li>基于交叉验证的训练控制</li>
<li>最终评估</li>
</ul>
</li>
<li><strong>部署</strong> 模型<ul>
<li>来自Python</li>
<li>来自C++和C＃</li>
<li>来自你自己的网络服务</li>
<li>通过Azure Web服务</li>
</ul>
</li>
<li>总结</li>
</ul>
<p>要运行本教程，你将需要CNTK v2，最好还有一个支持CUDA的GPU（没有GPU的深度学习可不好玩）。</p>
<p>我们从一些我们将在本教程的其余部分中使用的导入开始。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">from</span> <span style="color: #f8f8f2">__future__</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">print_function</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">cntk</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">numpy</span> <span style="color: #66d9ef">as</span> <span style="color: #f8f8f2">np</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">scipy.sparse</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">cntk.tests.test_utils</span>
<span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">tests</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">test_utils</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">set_device_from_pytest_env()</span> <span style="color: #75715e"># (only needed for our build system)</span>
<span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">cntk_py</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">set_fixed_random_seed(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #75715e"># fix the random seed so that LR examples are repeatable</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">IPython.display</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">Image</span>
<span style="color: #f92672">import</span> <span style="color: #f8f8f2">matplotlib.pyplot</span>
<span style="color: #f92672">%</span><span style="color: #f8f8f2">matplotlib</span> <span style="color: #f8f8f2">inline</span>
<span style="color: #f8f8f2">matplotlib</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pyplot</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">rcParams[</span><span style="color: #e6db74">&#39;figure.figsize&#39;</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2">)</span>
</pre></div>

<h2 id="_2">定义模型结构<a class="headerlink" href="#_2" title="Permanent link">#</a></h2>
<p>让我们一起深入。下面我们将介绍CNTK的数据模型和CNTK的编程模型 - 作为函数对象的网络（即网络可以被称为函数，它还包含一些状态，权重或参数，在学习期间可以调整）。我们将使用CNTK的Functional API将其用于逻辑回归和MNIST数字识别。最后，CNTK还有一个较低级别的图形API。我们将用它复制一个例子。</p>
<h3 id="cntk">CNTK编程模型：作为函数对象的网络<a class="headerlink" href="#cntk" title="Permanent link">#</a></h3>
<p>在CNTK中，神经网络是一个函数对象。一方面，CNTK中的神经网络只是一个可以调用以将其应用于数据的函数。另一方面，神经网络包含可以像对象成员一样访问的可学习参数。复杂的网络可以由更简单的层次结构组成，比如说，代表层。函数对象方法类似于Keras，Chainer，Dynet，PyTorch和Sonnet。</p>
<p>下面展示了使用函数对象的伪代码，使用全连接层（在CNTK中称为Dense）作为例子：</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e"># *Conceptual* numpy implementation of CNTK&#39;s Dense layer (simplified, e.g. no back-prop)</span>
<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">Dense</span><span style="color: #f8f8f2">(out_dim,</span> <span style="color: #f8f8f2">activation):</span>
    <span style="color: #75715e"># create the learnable parameters</span>
    <span style="color: #f8f8f2">b</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">zeros(out_dim)</span>
    <span style="color: #f8f8f2">W</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ndarray((</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,out_dim))</span> <span style="color: #75715e"># input dimension is unknown</span>
    <span style="color: #75715e"># define the function itself</span>
    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">dense</span><span style="color: #f8f8f2">(x):</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">len(W)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">:</span> <span style="color: #75715e"># first call: reshape and initialize W</span>
            <span style="color: #f8f8f2">W</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">resize((x</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">shape[</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">W</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">shape[</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]),</span> <span style="color: #f8f8f2">refcheck</span><span style="color: #f92672">=</span><span style="color: #66d9ef">False</span><span style="color: #f8f8f2">)</span>
            <span style="color: #f8f8f2">W[:]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">randn(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">W</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">shape)</span> <span style="color: #f92672">*</span> <span style="color: #ae81ff">0.05</span>
        <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">activation(x</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">dot(W)</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">b)</span>
    <span style="color: #75715e"># return as function object: can be called &amp; holds parameters as members</span>
    <span style="color: #f8f8f2">dense</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">W</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">W</span>
    <span style="color: #f8f8f2">dense</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">b</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">b</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">dense</span>

<span style="color: #f8f8f2">d</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Dense(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">tanh)</span>    <span style="color: #75715e"># create the function object</span>
<span style="color: #f8f8f2">y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">d(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">array([</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]))</span>  <span style="color: #75715e"># apply it like a function</span>
<span style="color: #f8f8f2">W</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">d</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">W</span>                  <span style="color: #75715e"># access member like an object</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;W =&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">d</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">W)</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;y =&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">y)</span>
</pre></div>

<p>再次强调，这只是伪代码。事实上，CNTK函数对象不支持numpy数组。相反，它们在内部表示为C++中用于编码计算的图结构，类似于其他深度学习工具集。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">d</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Dense(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">tanh)</span>
</pre></div>

<p>实际上只是构建一个图，</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">d(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">array([</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]))</span>
</pre></div>

<p>是将数据喂给图结构引擎。</p>
<p>这个图结构包含在Python类中，该函数公开必要的接口，以便其他Python函数可以调用它并访问其成员（例如W和b）。</p>
<p>函数对象是CNTK的单一抽象，用于表示不同的操作，这些操作仅按约定区分：</p>
<ul>
<li>没有可学习参数的 <strong>基本操作</strong> （例如<code>+</code>，<code>*</code>，<code>sigmoid()</code>……）</li>
<li><strong>层</strong> （<code>Dense()</code>，<code>Embedding()</code>，<code>Convolution()</code>……）。层将一个输入映射到一个输出，并且可以附加可学习的参数。</li>
<li><strong>循环步骤函数</strong> （<code>LSTM()</code>，<code>GRU()</code>，<code>RNNStep()</code>）。步骤函数将先前状态和新输入映射到新状态。</li>
<li><strong>损失和度量函数</strong> （<code>cross_entropy_with_softmax()</code>，<code>binary_cross_entropy()</code>，<code>squared_error()</code>，<code>classification_error()</code>……）。在CNTK中，损失和度量并不特别，它们只是函数。唯一的区别是，虽然CNTK的函数可以有一个或多个输出，但损失和度量必须具有单个输出。请注意，损失不必输出标量值：如果损失的输出不是标量，CNTK将自动将损失定义为输出的总和。可以通过自己显式执行缩减操作来覆盖此行为。</li>
<li><strong>模型</strong> 。模型由用户定义。模型将特征映射到预测或分数，并最终部署。</li>
<li><strong>准则函数</strong> 。准则函数将（特征，标签）映射到损失并且可选地映射到度量。训练器通过SGD优化损失，并记录指标。度量或许是不可微的，但损失一定是可微的。</li>
</ul>
<p>高阶层将对象组合成更复杂的对象，包括：</p>
<ul>
<li>层堆叠（<code>Sequential()</code>，<code>For()</code>）</li>
<li>循环（<code>Recurrence()</code>，<code>Fold()</code>，<code>UnfoldFrom()</code>，……）</li>
</ul>
<p>网络通常通过使用现有CNTK函数（例如特定类型的神经网络层）并使用<code>Sequential()</code>组成它们来定义。此外，用户可以将自己的函数编写为任意Python表达式，只要这些表达式包含对CNTK数据类型的CNTK操作。Python表达式通过将它们包装在对<code>Function()</code>的调用中而转换为内部表示。表达式可以通过装饰器语法（<code>@Function</code>）编写为多行函数。</p>
<p>即使通过组合CNTK的原语无法表达操作，也有通过在Python（或C ++）中编写自己的“层”来扩展CNTK的机制。这是高级功能，你现在不必担心，但如果你需要它，最好了解它。</p>
<p>最后，CNTK函数对象可以轻松进行参数共享。如果在多个位置调用相同的函数对象，则所有调用自然会共享相同的可学习参数。要避免共享参数，只需创建两个不同的函数对象。</p>
<p>总之，函数对象是CNTK的单一抽象，用于方便地定义简单和复杂模型，参数共享和培训目标。</p>
<p>也可以根据其底层图形操作直接定义CNTK网络，类似于许多其他工具集。你可以在定义神经网络的两种风格之间自由混合和匹配。这将在下面进一步讨论。</p>
<h3 id="cntk_1">CNTK数据模型：张量和张量序列<a class="headerlink" href="#cntk_1" title="Permanent link">#</a></h3>
<p>CNTK可以对两种类型的数据进行操作：</p>
<ul>
<li>张量（即N维阵列），密集或稀疏</li>
<li>张量序列</li>
</ul>
<p>他们的区别在于张量的形状在操作期间是静态的，而张量序列的长度取决于数据。在CNTK中，我们使用轴来表示与numpy数组的尺寸相同的东西，即形状的张量（7,10,6）具有三个轴。张量具有静态轴，而序列具有附加的动态轴。因此，动态轴是可变长度轴。</p>
<p>分类数据表示为稀疏的独热张量（即除了在其编码的类别的位置处的单个1之外具有所有元素0）。这允许以统一的方式将嵌套和损失函数写为矩阵的积。</p>
<p>打印CNTK函数将为你提供类似于以下格式的输出：</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">Operation(Sequence[Tensor[shape]],</span> <span style="color: #f8f8f2">other</span> <span style="color: #f8f8f2">arguments)</span> <span style="color: #f92672">-&gt;</span> <span style="color: #f8f8f2">Tensor[shape]</span>
</pre></div>

<p>当 <em>Operation</em> 为<code>Composite</code>时，该函数代表其下方的整个图，且显示的内容仅为最后一个操作。该图具有一定数量的有特定类型期望的输入。打印函数时，你将注意到 <strong>缺少批量维度</strong>。CNTK对用户隐藏了批。我们希望用户在张量和序列中进行思考，并将小批次处理留给CNTK。与其他工具集不同，CNTK还可以自动将具有不同长度的序列批量分成一个小批次，并处理所有必要的填充和包装。像“bucketing”这样的解决方法是不需要的。我们将动态轴（批和序列）与静态轴分开的原因是因为影响这些轴的操作非常少。默认情况下，你希望对批处理中的每个示例以及序列的每个元素执行某些操作。只有少数特殊操作（例如循环或批标准化）需要处理这些轴。</p>
<h3 id="cntklogistic">你的第一个CNTK网络：Logistic回归<a class="headerlink" href="#cntklogistic" title="Permanent link">#</a></h3>
<p>让我们将所有这些应用于一个非常简单的逻辑回归。对于这个例子，我们创建了一个二维正态分布数据点的合成数据集，它应该被归类为属于两个类中的一个。请注意，CNTK期望标签为独热编码。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">input_dim_lr</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">2</span>    <span style="color: #75715e"># classify 2-dimensional data</span>
<span style="color: #f8f8f2">num_classes_lr</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">2</span>  <span style="color: #75715e"># into one of two classes</span>

<span style="color: #75715e"># This example uses synthetic data from normal distributions,</span>
<span style="color: #75715e"># which we generate in the following.</span>
<span style="color: #75715e">#  X_lr[corpus_size,input_dim] - input data</span>
<span style="color: #75715e">#  Y_lr[corpus_size]           - labels (0 or 1), one-hot-encoded</span>
<span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">seed(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">generate_synthetic_data</span><span style="color: #f8f8f2">(N):</span>
    <span style="color: #f8f8f2">Y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">randint(size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">N,</span> <span style="color: #f8f8f2">low</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">high</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">num_classes_lr)</span>  <span style="color: #75715e"># labels</span>
    <span style="color: #f8f8f2">X</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">randn(N,</span> <span style="color: #f8f8f2">input_dim_lr)</span><span style="color: #f92672">+</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">(Y[:,</span><span style="color: #66d9ef">None</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">+</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span>   <span style="color: #75715e"># data</span>
    <span style="color: #75715e"># Our model expects float32 features, and cross-entropy</span>
    <span style="color: #75715e"># expects one-hot encoded labels.</span>
    <span style="color: #f8f8f2">Y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">scipy</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sparse</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">csr_matrix((np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ones(N,np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">float32),</span> <span style="color: #f8f8f2">(range(N),</span> <span style="color: #f8f8f2">Y)),</span> <span style="color: #f8f8f2">shape</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(N,</span> <span style="color: #f8f8f2">num_classes_lr))</span>
    <span style="color: #f8f8f2">X</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">X</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">float32)</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">X,</span> <span style="color: #f8f8f2">Y</span>
<span style="color: #f8f8f2">X_train_lr,</span> <span style="color: #f8f8f2">Y_train_lr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">generate_synthetic_data(</span><span style="color: #ae81ff">20000</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">X_test_lr,</span>  <span style="color: #f8f8f2">Y_test_lr</span>  <span style="color: #f92672">=</span> <span style="color: #f8f8f2">generate_synthetic_data(</span><span style="color: #ae81ff">1024</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;data =</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">X_train_lr[:</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">])</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;labels =</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">Y_train_lr[:</span><span style="color: #ae81ff">4</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">todense())</span>
</pre></div>

<p>现在，我们定义模型函数。模型函数将输入数据映射到预测。它是培训过程的最终产品。在这个例子中，我们使用最简单的所有模型：逻辑回归。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">model_lr_factory</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dense(num_classes_lr,</span> <span style="color: #f8f8f2">activation</span><span style="color: #f92672">=</span><span style="color: #66d9ef">None</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">x</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(input_dim_lr)</span>
<span style="color: #f8f8f2">y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(num_classes_lr,</span> <span style="color: #f8f8f2">is_sparse</span><span style="color: #f92672">=</span><span style="color: #66d9ef">True</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">model_lr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">model_lr_factory(x)</span>
</pre></div>

<p>接下来，我们定义准则函数。准则函数是训练器用于优化模型的准测：它将（输入矢量，标签）映射到（损失，度量）。损失被用于SGD更新。我们选择交叉熵。具体来说，<code>cross_entropy_with_softmax()</code>首先将<code>softmax()</code>函数应用于网络的输出，因为交叉熵需要概率。我们没有将<code>softmax()</code>包含在模型函数本身当中，因为它不需要使用模型。我们计算分类错误作为作为度量标准（此度量标准不可微）。</p>
<p>我们将准则函数定义为Python代码并将其转换为<code>Function</code>对象。单个表达式可以写为<code>Function(lambda x, y:expression of x and y)</code>，类似于Keras的<code>Lambda()</code>。为了避免对模型进行两次评估，我们使用带有装饰器语法的Python函数定义。这同时也是告诉CNTK输入数据的类型的时候。这些通过装饰器<code>@Function</code>完成：</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #a6e22e">@cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Function</span>
<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">criterion_lr_factory</span><span style="color: #f8f8f2">(data,</span> <span style="color: #f8f8f2">label_one_hot):</span>
    <span style="color: #f8f8f2">z</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">model_lr_factory(data)</span>  <span style="color: #75715e"># apply model. Computes a non-normalized log probability for every output class.</span>
    <span style="color: #f8f8f2">loss</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">cross_entropy_with_softmax(z,</span> <span style="color: #f8f8f2">label_one_hot)</span> <span style="color: #75715e"># applies softmax to z under the hood</span>
    <span style="color: #f8f8f2">metric</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">classification_error(z,</span> <span style="color: #f8f8f2">label_one_hot)</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">loss,</span> <span style="color: #f8f8f2">metric</span>
<span style="color: #f8f8f2">criterion_lr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">criterion_lr_factory(x,</span> <span style="color: #f8f8f2">y)</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;criterion_lr:&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">criterion_lr)</span>
</pre></div>

<p>装饰器将Python函数“编译”为CNTK的内部图表示。因此，结果<code>criterion</code>不是Python函数，而是CNTK <code>Function</code>对象。</p>
<p>现在，我们已准备好训练我们的模型。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">learner</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sgd(model_lr</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">parameters,</span>
                   <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">learning_parameter_schedule(</span><span style="color: #ae81ff">0.1</span><span style="color: #f8f8f2">))</span>
<span style="color: #f8f8f2">progress_writer</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">logging</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ProgressPrinter(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span>

<span style="color: #f8f8f2">criterion_lr</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">train((X_train_lr,</span> <span style="color: #f8f8f2">Y_train_lr),</span> <span style="color: #f8f8f2">parameter_learners</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[learner],</span>
                   <span style="color: #f8f8f2">callbacks</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[progress_writer])</span>

<span style="color: #f8f8f2">print(model_lr</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">W</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">value)</span> <span style="color: #75715e"># peek at updated W</span>
</pre></div>

<p><code>learner</code>是实际执行模型时更新的对象。其他学习器包括<code>momentum_sgd()</code>和<code>adam()</code>。<code>progress_writer</code>是一个内置的记录回调函数，用于打印输出，你也可以自己进行替换，或使用自带的<code>TensorBoardProgressWriter</code>来通过TensorBoard可视化训练进度。</p>
<p><code>train()</code>函数将我们的数据<code>(X_train_lr，Y_train_lr)</code>一小批次一小批次的提供给模型并更新它，其中数据是一个元组，其顺序与<code>criterion_lr()</code>的参数相同。</p>
<p>让我们测试一下我们在测试集上的表现（这也会一小批次一小批次的运行）。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">test_metric_lr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">criterion_lr</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">test((X_test_lr,</span> <span style="color: #f8f8f2">Y_test_lr),</span>
                                   <span style="color: #f8f8f2">callbacks</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[progress_writer])</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">metric</span>
</pre></div>

<p>最后，让我们通过我们的模型运行一些示例，看看它做的怎么样。啊，<code>criterion</code>知道输入类型，但是<code>model_lr</code>并不知道，所以我们得告诉它。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">model_lr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">model_lr_factory(x)</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;model_lr:&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">model_lr)</span>
</pre></div>

<p>现在，我们可以像调用任何Python函数一样调用它：</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">z</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">model_lr(X_test_lr[:</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">])</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&quot;Label    :&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[label</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">todense()</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">argmax()</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">label</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">Y_test_lr[:</span><span style="color: #ae81ff">20</span><span style="color: #f8f8f2">]])</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&quot;Predicted:&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">[z[i,:]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">argmax()</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">range(len(z))])</span>
</pre></div>

<h3 id="cntkmnist">你的第二个CNTK网络：MNIST数字识别<a class="headerlink" href="#cntkmnist" title="Permanent link">#</a></h3>
<p>让我们在实际任务 -- MNIST基准上做与上面一样的事情。这是深度学习的“hello, world”。MNIST是对扫描的手写数字进行识别。我们首先下载并准备数据。在教程103C中，你可以找到一种更简洁的方法来使用CNTK内置的便捷功能编写整个MNIST数字识别工作流程</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">input_shape_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">28</span><span style="color: #f8f8f2">)</span>  <span style="color: #75715e"># MNIST digits are 28 x 28</span>
<span style="color: #f8f8f2">num_classes_mn</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">10</span>        <span style="color: #75715e"># classify as one of 10 digits</span>

<span style="color: #75715e"># Fetch the MNIST data. Best done with scikit-learn.</span>
<span style="color: #66d9ef">try</span><span style="color: #f8f8f2">:</span>
    <span style="color: #f92672">from</span> <span style="color: #f8f8f2">sklearn</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">datasets,</span> <span style="color: #f8f8f2">utils</span>
    <span style="color: #f8f8f2">mnist</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">datasets</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">fetch_mldata(</span><span style="color: #e6db74">&quot;MNIST original&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #f8f8f2">X,</span> <span style="color: #f8f8f2">Y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">mnist</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">data</span> <span style="color: #f92672">/</span> <span style="color: #ae81ff">255.0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">mnist</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">target</span>
    <span style="color: #f8f8f2">X_train_mn,</span> <span style="color: #f8f8f2">X_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">X[:</span><span style="color: #ae81ff">60000</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">reshape((</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">)),</span> <span style="color: #f8f8f2">X[</span><span style="color: #ae81ff">60000</span><span style="color: #f8f8f2">:]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">reshape((</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">))</span>
    <span style="color: #f8f8f2">Y_train_mn,</span> <span style="color: #f8f8f2">Y_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Y[:</span><span style="color: #ae81ff">60000</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(int),</span> <span style="color: #f8f8f2">Y[</span><span style="color: #ae81ff">60000</span><span style="color: #f8f8f2">:]</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(int)</span>
<span style="color: #66d9ef">except</span><span style="color: #f8f8f2">:</span> <span style="color: #75715e"># workaround if scikit-learn is not present</span>
    <span style="color: #f92672">import</span> <span style="color: #f8f8f2">requests</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">io</span><span style="color: #f92672">,</span> <span style="color: #f8f8f2">gzip</span>
    <span style="color: #f8f8f2">X_train_mn,</span> <span style="color: #f8f8f2">X_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">fromstring(gzip</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">GzipFile(fileobj</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">io</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">BytesIO(requests</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get(</span><span style="color: #e6db74">&#39;http://yann.lecun.com/exdb/mnist/&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">name</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&#39;-images-idx3-ubyte.gz&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">content))</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">read()[</span><span style="color: #ae81ff">16</span><span style="color: #f8f8f2">:],</span> <span style="color: #f8f8f2">dtype</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">uint8)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">reshape((</span><span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">28</span><span style="color: #f8f8f2">))</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">float32)</span> <span style="color: #f92672">/</span> <span style="color: #ae81ff">255.0</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">name</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;train&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;t10k&#39;</span><span style="color: #f8f8f2">))</span>
    <span style="color: #f8f8f2">Y_train_mn,</span> <span style="color: #f8f8f2">Y_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">fromstring(gzip</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">GzipFile(fileobj</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">io</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">BytesIO(requests</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get(</span><span style="color: #e6db74">&#39;http://yann.lecun.com/exdb/mnist/&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">name</span> <span style="color: #f92672">+</span> <span style="color: #e6db74">&#39;-labels-idx1-ubyte.gz&#39;</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">content))</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">read()[</span><span style="color: #ae81ff">8</span><span style="color: #f8f8f2">:],</span> <span style="color: #f8f8f2">dtype</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">uint8)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(int)</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">name</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">(</span><span style="color: #e6db74">&#39;train&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&#39;t10k&#39;</span><span style="color: #f8f8f2">))</span>

<span style="color: #75715e"># Shuffle the training data.</span>
<span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">seed(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #75715e"># always use the same reordering, for reproducability</span>
<span style="color: #f8f8f2">idx</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">random</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">permutation(len(X_train_mn))</span>
<span style="color: #f8f8f2">X_train_mn,</span> <span style="color: #f8f8f2">Y_train_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">X_train_mn[idx],</span> <span style="color: #f8f8f2">Y_train_mn[idx]</span>

<span style="color: #75715e"># Further split off a cross-validation set</span>
<span style="color: #f8f8f2">X_train_mn,</span> <span style="color: #f8f8f2">X_cv_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">X_train_mn[:</span><span style="color: #ae81ff">54000</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">X_train_mn[</span><span style="color: #ae81ff">54000</span><span style="color: #f8f8f2">:]</span>
<span style="color: #f8f8f2">Y_train_mn,</span> <span style="color: #f8f8f2">Y_cv_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">Y_train_mn[:</span><span style="color: #ae81ff">54000</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">Y_train_mn[</span><span style="color: #ae81ff">54000</span><span style="color: #f8f8f2">:]</span>

<span style="color: #75715e"># Our model expects float32 features, and cross-entropy expects one-hot encoded labels.</span>
<span style="color: #f8f8f2">Y_train_mn,</span> <span style="color: #f8f8f2">Y_cv_mn,</span> <span style="color: #f8f8f2">Y_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(scipy</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">sparse</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">csr_matrix((np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ones(len(Y),np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">float32),</span> <span style="color: #f8f8f2">(range(len(Y)),</span> <span style="color: #f8f8f2">Y)),</span> <span style="color: #f8f8f2">shape</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(len(Y),</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">))</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">Y</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">(Y_train_mn,</span> <span style="color: #f8f8f2">Y_cv_mn,</span> <span style="color: #f8f8f2">Y_test_mn))</span>
<span style="color: #f8f8f2">X_train_mn,</span> <span style="color: #f8f8f2">X_cv_mn,</span> <span style="color: #f8f8f2">X_test_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(X</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">astype(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">float32)</span> <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">X</span> <span style="color: #f92672">in</span> <span style="color: #f8f8f2">(X_train_mn,</span> <span style="color: #f8f8f2">X_cv_mn,</span> <span style="color: #f8f8f2">X_test_mn))</span>

<span style="color: #75715e"># Have a peek.</span>
<span style="color: #f8f8f2">matplotlib</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pyplot</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">rcParams[</span><span style="color: #e6db74">&#39;figure.figsize&#39;</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">0.5</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">matplotlib</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pyplot</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">axis(</span><span style="color: #e6db74">&#39;off&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">_</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">matplotlib</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">pyplot</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">imshow(np</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">concatenate(X_train_mn[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">:</span><span style="color: #ae81ff">10</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">axis</span><span style="color: #f92672">=</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">cmap</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;gray_r&quot;</span><span style="color: #f8f8f2">)</span>
</pre></div>

<p>让我们定义CNTK模型函数来将（28x28）维图像映射到10维评分向量。我们将它包装在一个函数中，以便在本教程的后面我们可以轻松地重新创建它。对于那些熟悉Tutorial 103D的人，你将学习如何使用层库来组成更大的网络，以简单的方式训练和测试它们。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #66d9ef">def</span> <span style="color: #a6e22e">create_model_mn_factory</span><span style="color: #f8f8f2">():</span>
    <span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">default_options(activation</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ops</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">relu,</span> <span style="color: #f8f8f2">pad</span><span style="color: #f92672">=</span><span style="color: #66d9ef">False</span><span style="color: #f8f8f2">):</span>
        <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Sequential([</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">reduction_rank</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">pad</span><span style="color: #f92672">=</span><span style="color: #66d9ef">True</span><span style="color: #f8f8f2">),</span> <span style="color: #75715e"># reduction_rank=0 for B&amp;W images</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">MaxPooling((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">strides</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">48</span><span style="color: #f8f8f2">),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">MaxPooling((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">strides</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">)),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">64</span><span style="color: #f8f8f2">),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dense(</span><span style="color: #ae81ff">96</span><span style="color: #f8f8f2">),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dropout(dropout_rate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0.5</span><span style="color: #f8f8f2">),</span>
            <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dense(num_classes_mn,</span> <span style="color: #f8f8f2">activation</span><span style="color: #f92672">=</span><span style="color: #66d9ef">None</span><span style="color: #f8f8f2">)</span> <span style="color: #75715e"># no activation in final layer (softmax is done in criterion)</span>
        <span style="color: #f8f8f2">])</span>
<span style="color: #f8f8f2">model_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">create_model_mn_factory()</span>
</pre></div>

<p>这个模型有点复杂！它由几个卷积层和两个全连接层组成以用于分类，MNIST的典型目标。这演示了CNTK函数API的几个方面。</p>
<p>首先，我们使用CNTK的层库（<code>cntk.layers</code>）中的函数创建每个层。</p>
<p>其次，高阶层<code>Sequential()</code>创建一个新的函数，一个接一个地应用所有这些层。这是已知的<a href="https://zh.wikipedia.org/wiki/%E5%A4%8D%E5%90%88%E5%87%BD%E6%95%B0">前向复合函数</a>。请注意，与其他工具集不同，你不能在随后<code>Add()</code>更多层到序列层。CNTK的<code>Function</code>对象是不可变的，除了可学习的参数（要编辑<code>Function</code>对象，你可以<code>clone()</code>它）。如果你更喜欢那种样式，请将层创建为Python列表并将其传递给<code>Sequential()</code>。</p>
<p>第三，上下文管理器<code>default_options()</code>允许为层的各种可选参数指定默认值，例如激活函数始终是<code>relu</code>，除非重写。</p>
<p>最后，请注意<code>relu</code>作为实际函数传递，而不是字符串。任何函数都可以是激活函数。它也可以直接传递Python lambda，例如<code>relu</code>也可以通过<code>activation=lambda x: cntk.ops.element_max(x, 0)</code>手动实现。</p>
<p>准则函数的定义与前面的示例类似，用于将图片（28x28）维特征和相应标签映射到损失和度量。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #a6e22e">@cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Function</span>
<span style="color: #66d9ef">def</span> <span style="color: #a6e22e">criterion_mn_factory</span><span style="color: #f8f8f2">(data,</span> <span style="color: #f8f8f2">label_one_hot):</span>
    <span style="color: #f8f8f2">z</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">model_mn(data)</span>
    <span style="color: #f8f8f2">loss</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">cross_entropy_with_softmax(z,</span> <span style="color: #f8f8f2">label_one_hot)</span>
    <span style="color: #f8f8f2">metric</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">classification_error(z,</span> <span style="color: #f8f8f2">label_one_hot)</span>
    <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">loss,</span> <span style="color: #f8f8f2">metric</span>
<span style="color: #f8f8f2">x</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(input_shape_mn)</span>
<span style="color: #f8f8f2">y</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(num_classes_mn,</span> <span style="color: #f8f8f2">is_sparse</span><span style="color: #f92672">=</span><span style="color: #66d9ef">True</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">criterion_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">criterion_mn_factory(x,y)</span>
</pre></div>

<p>对于训练，让我们把动量加入进来。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">N</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">len(X_train_mn)</span>
<span style="color: #f8f8f2">lrs</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">learning_parameter_schedule_per_sample([</span><span style="color: #ae81ff">0.001</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">12</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.0005</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">6</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.00025</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">6</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.000125</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">3</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.0000625</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">3</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.00003125</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">epoch_size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">N)</span>
<span style="color: #f8f8f2">momentums</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">momentum_schedule_per_sample([</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">5</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">0.9990239141819757</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">epoch_size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">N)</span>
<span style="color: #f8f8f2">minibatch_sizes</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">minibatch_size_schedule([</span><span style="color: #ae81ff">256</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">6</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">512</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">9</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">1024</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">7</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">2048</span><span style="color: #f8f8f2">]</span><span style="color: #f92672">*</span><span style="color: #ae81ff">8</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">[</span><span style="color: #ae81ff">4096</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">epoch_size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">N)</span>

<span style="color: #f8f8f2">learner</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">learners</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">momentum_sgd(model_mn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">parameters,</span> <span style="color: #f8f8f2">lrs,</span> <span style="color: #f8f8f2">momentums)</span>
</pre></div>

<p>这看起来有点不寻常。首先，学习率被指定为列表（<code>[0.001] * 12 + [0.0005] * 6 +</code> ……）。与<code>epoch_size</code>参数一起，这告诉CNTK对于前12个周期使用0.001，接下来的六个周期使用0.0005，等等。</p>
<p>其次，学习率被指定为好像它应用于大小为1（每个样本）的小批次，并且动量作为时间常数。这些值直接指定每个样本的梯度对模型的贡献的权重，以及随着训练的进展其贡献如何衰减。CNTK将根据读者提供的数据的实际小批次大小来调整学习率和动量。缩放的净效果将使学习速度和动量好像应用于大小为1的小批次。这种独特的CNTK函数允许调整小批次大小而无需重新调整这些参数。在这里，我们将它从256增加到4096，导致最后的操作速度提高3倍（在Titan-X上）。</p>
<p>好的，现在让我们训练模型。在Titan-X上，这将运行大约一分钟。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">progress_writer</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">logging</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ProgressPrinter()</span>
<span style="color: #f8f8f2">criterion_mn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">train((X_train_mn,</span> <span style="color: #f8f8f2">Y_train_mn),</span> <span style="color: #f8f8f2">minibatch_size</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">minibatch_sizes,</span>
                   <span style="color: #f8f8f2">max_epochs</span><span style="color: #f92672">=</span><span style="color: #ae81ff">40</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">parameter_learners</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[learner],</span> <span style="color: #f8f8f2">callbacks</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[progress_writer])</span>
<span style="color: #f8f8f2">test_metric_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">criterion_mn</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">test((X_test_mn,</span> <span style="color: #f8f8f2">Y_test_mn),</span> <span style="color: #f8f8f2">callbacks</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">[progress_writer])</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">metric</span>
</pre></div>

<h3 id="apimnist">图谱API：再来一次MNIST数字识别<a class="headerlink" href="#apimnist" title="Permanent link">#</a></h3>
<p>CNTK还允许使用图级API编写网络。这个API更冗长，但有时更灵活。以下定义了与上述相同的模型和准则函数，并将得到相同的结果。</p>
<div class="codehilite" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">images</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(input_shape_mn,</span> <span style="color: #f8f8f2">name</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;images&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">with</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">default_options(activation</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">ops</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">relu,</span> <span style="color: #f8f8f2">pad</span><span style="color: #f92672">=</span><span style="color: #66d9ef">False</span><span style="color: #f8f8f2">):</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">5</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">32</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">reduction_rank</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">pad</span><span style="color: #f92672">=</span><span style="color: #66d9ef">True</span><span style="color: #f8f8f2">)(images)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">MaxPooling((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">strides</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))(r)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">48</span><span style="color: #f8f8f2">)(r)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">MaxPooling((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">strides</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">))(r)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Convolution2D((</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">,</span><span style="color: #ae81ff">3</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">num_filters</span><span style="color: #f92672">=</span><span style="color: #ae81ff">64</span><span style="color: #f8f8f2">)(r)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dense(</span><span style="color: #ae81ff">96</span><span style="color: #f8f8f2">)(r)</span>
    <span style="color: #f8f8f2">r</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dropout(dropout_rate</span><span style="color: #f92672">=</span><span style="color: #ae81ff">0.5</span><span style="color: #f8f8f2">)(r)</span>
    <span style="color: #f8f8f2">model_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">layers</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">Dense(num_classes_mn,</span> <span style="color: #f8f8f2">activation</span><span style="color: #f92672">=</span><span style="color: #66d9ef">None</span><span style="color: #f8f8f2">)(r)</span>

<span style="color: #f8f8f2">label_one_hot</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">input_variable(num_classes_mn,</span> <span style="color: #f8f8f2">is_sparse</span><span style="color: #f92672">=</span><span style="color: #66d9ef">True</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">name</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;labels&#39;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">loss</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">cross_entropy_with_softmax(model_mn,</span> <span style="color: #f8f8f2">label_one_hot)</span>
<span style="color: #f8f8f2">metric</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">classification_error(model_mn,</span> <span style="color: #f8f8f2">label_one_hot)</span>
<span style="color: #f8f8f2">criterion_mn</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">cntk</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">combine([loss,</span> <span style="color: #f8f8f2">metric])</span>
<span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&#39;criterion_mn:&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">criterion_mn)</span>
</pre></div><h2 id="__comments">评论</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
      this.page.url = "https://zyc.ai/cntk/200/";
      this.page.identifier =
        "/cntk/200/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//intzc.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();</script></article></div></div></main><footer class="md-footer"><div class="md-footer-nav"><nav class="md-footer-nav__inner md-grid"><a href="../introduction/" title="导论" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev"><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-back md-footer-nav__button"></i></div><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">后退</span>导论</span></div></a><a href="../../cppcg/CppCoreGuidelines/" title="原文" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next"><div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span class="md-flex__ellipsis"><span class="md-footer-nav__direction">前进</span>原文</span></div><div class="md-flex__cell md-flex__cell--shrink"><i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i></div></a></nav></div><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class="md-footer-copyright"><div class="md-footer-copyright__highlight">All rights reserved © Zhiyuan Chen 2017-2020</div>powered by <a href="https://www.mkdocs.org">MkDocs</a> and <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a></div><div class="md-footer-social"><link rel="stylesheet" href="../../assets/fonts/font-awesome.css"> <a href="https://github.com/zyc-ai" class="md-footer-social__link fa fa-github"></a>  <a href="https://www.linkedin.com/in/%E9%99%9F%E5%8E%9F-%E9%99%88-0b473aa9/" class="md-footer-social__link fa fa-linkedin"></a> </div></div></div></footer></div><script src="../../assets/javascripts/application.b260a35d.js"></script><script src="../../assets/javascripts/lunr/lunr.stemmer.support.js"></script><script src="../../assets/javascripts/lunr/tinyseg.js"></script><script src="../../assets/javascripts/lunr/lunr.ja.js"></script><script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>